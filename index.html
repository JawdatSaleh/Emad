
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- ألوان وتصميم -->
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

  :root{
    --brand:#2563eb;          /* أزرق حديث للهوية */
    --brand-dark:#1d4ed8;     /* درجة أغمق للتباين */
    --ok:#10b981;             /* أخضر نيون هادئ */
    --danger:#ef4444;         /* أحمر واضح للتحذير */
    --surface:#ffffff;
    --surface-muted:#f3f6ff;  /* خلفية لطيفة فاتحة */
    --text-main:#0f172a;
    --text-muted:#64748b;
    --shadow-soft:0 16px 35px rgba(37,99,235,.08);
    --shadow-strong:0 30px 70px rgba(15,23,42,.28);
  }
  html{direction:rtl}
  *{box-sizing:border-box}
  body{font-family:"Cairo","Noto Sans Arabic",system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--surface-muted);margin:0;color:var(--text-main);line-height:1.5;text-align:right}
  header{background:linear-gradient(120deg,var(--brand),var(--brand-dark));color:#fff;padding:44px 22px 32px;border-bottom-left-radius:20px;border-bottom-right-radius:20px;box-shadow:var(--shadow-strong)}
  header .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:18px;flex-wrap:wrap}
  header h1{margin:0;font-size:24px;font-weight:700;letter-spacing:.6px}
  .user-area{display:none;align-items:center;gap:12px;font-size:14px;font-weight:600}
  .user-area.visible{display:flex}
  .user-area .user-email{padding:8px 14px;border-radius:999px;background:rgba(255,255,255,.18);box-shadow:0 4px 12px rgba(12,36,64,.15)}
  .user-area .logout-button{background:rgba(215,38,61,.92);padding-inline:18px;border-radius:999px}
  .user-area .logout-button:hover{filter:brightness(.95)}

  .container{max-width:1200px;margin:24px auto;background:var(--surface);padding:22px;border-radius:20px;box-shadow:var(--shadow-soft);border:1px solid rgba(37,99,235,.06)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}
  .card{background:var(--surface);color:var(--text-main);padding:14px;border-radius:16px;display:flex;flex-direction:column;gap:6px;box-shadow:0 10px 22px rgba(15,23,42,.05);min-height:110px;position:relative;overflow:hidden;transition:transform .2s ease,box-shadow .2s ease;border:1px solid #e2e8f0}
  .card small{font-size:12px;color:var(--text-muted);font-weight:600}
  .card b{font-size:20px;font-weight:700;color:var(--brand-dark)}
  .summary-card{min-height:28px;padding:10px 12px;gap:2px;background:#f8fafc;border:1px solid #e2e8f0;box-shadow:none}
  .summary-card small{line-height:1.2}
  .summary-card b{line-height:1.15}
  .summary-card.cash-card{background:#fff1f2;border-color:rgba(239,68,68,.35)}
  .summary-card.cash-card b{color:var(--danger)}

  .card:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(15,23,42,.08)}
  .category-card{background:#f8fafc;border:1px solid #e2e8f0;min-height:90px;padding:12px}
  .category-card.clickable{cursor:pointer;border-color:rgba(37,99,235,.24)}
  .category-card.clickable:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.25)}
  .card-header{display:flex;justify-content:flex-start;align-items:center;gap:10px}
  .card-title{font-size:13px;font-weight:700;color:var(--text-main)}
  .card-subtitle{font-size:10px;color:var(--text-muted)}
  .card-amount{font-size:18px;font-weight:700;color:var(--brand-dark)}
  .card-remaining{display:none}
  .revenue-card{min-height:110px;cursor:pointer;border:1px solid #e2e8f0;background:#f8fafc}
  .revenue-card:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.25)}
  .revenue-card .card-header{justify-content:space-between}
  .revenue-card .card-title{font-size:14px}
  .revenue-card .card-subtitle{font-size:11px}
  .revenue-card .card-amount{font-size:20px}
  .progress-shell{position:relative;background:#e2e8f0;border-radius:12px;height:8px;overflow:hidden;margin-top:8px}
  .progress-bar{position:absolute;inset:0;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-dark));width:0%;transition:width .8s cubic-bezier(.4,0,.2,1)}
  .progress-shell[data-alert="true"] .progress-bar{background:linear-gradient(90deg,var(--danger),#fb7185)}
  .progress-label{position:absolute;top:50%;inset-inline-start:50%;transform:translate(-50%,-50%);font-size:10px;font-weight:700;color:var(--text-main)}
  .currency-symbol{font-size:0.75em;opacity:0.85;margin-inline-start:4px;display:inline-block;}

  .modal-backdrop{position:fixed;inset:0;background:radial-gradient(circle at 20% 20%,rgba(37,99,235,.15),transparent 35%),rgba(15,23,42,.55);display:flex;align-items:center;justify-content:center;padding:24px;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s ease}
  .modal-backdrop.active{opacity:1;pointer-events:all}
  .modal-panel{position:relative;width:min(680px,100%);max-height:90vh;overflow-y:auto;background:var(--surface);border-radius:24px;padding:28px;box-shadow:var(--shadow-strong);border:1px solid rgba(37,99,235,.18)}
  .modal-panel::-webkit-scrollbar{width:8px}
  .modal-panel::-webkit-scrollbar-thumb{background:rgba(37,99,235,.35);border-radius:999px}
  .modal-close{position:absolute;top:18px;inset-inline-end:18px;width:36px;height:36px;border-radius:12px;border:none;background:rgba(37,99,235,.12);color:var(--brand-dark);font-size:22px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:background .25s ease,color .25s ease,transform .2s ease}
  .modal-close:hover{background:rgba(37,99,235,.18);color:#fff;transform:translateY(-1px)}
  .modal-share{position:absolute;top:18px;inset-inline-start:18px;display:inline-flex;align-items:center;gap:8px;padding:0 16px;height:36px;border-radius:12px;border:none;background:linear-gradient(135deg,rgba(37,99,235,.14),rgba(16,185,129,.18));color:var(--brand-dark);font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(37,99,235,.18);transition:transform .25s ease,box-shadow .25s ease,filter .25s ease}
  .modal-share:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(37,99,235,.2);filter:brightness(1.05)}
  .modal-share:disabled{opacity:.6;cursor:progress;transform:none;box-shadow:0 4px 12px rgba(37,99,235,.12)}
  .modal-share .share-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:rgba(37,99,235,.2);color:var(--brand-dark);font-size:11px;font-weight:700}
  .modal-title{margin:0;font-size:20px;font-weight:700;color:var(--text-main)}
  .modal-subtitle{margin:6px 0 18px;font-size:13px;color:var(--text-muted)}
  .modal-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px}
  .modal-summary .summary-item{background:linear-gradient(140deg,rgba(37,99,235,.12),rgba(16,185,129,.08));border:1px solid rgba(37,99,235,.14);border-radius:18px;padding:12px 16px;display:flex;flex-direction:column;gap:4px}
  .modal-summary .summary-label{font-size:12px;color:var(--text-muted);font-weight:600}
  .modal-summary .summary-value{font-size:16px;font-weight:700;color:var(--brand-dark)}
  .modal-summary .summary-value strong{color:var(--ok)}
  .modal-table-wrapper{margin-top:12px;border-radius:18px;overflow:auto;box-shadow:inset 0 0 0 1px rgba(37,99,235,.12)}
  .modal-table-wrapper .records-table{min-width:620px;border-radius:18px;margin:0}
  .modal-table-wrapper .records-table thead th{top:0}
  .stages-list{display:flex;flex-direction:column;gap:14px}
  .stage-card{padding:18px 20px;border-radius:20px;border:1px solid rgba(37,99,235,.14);background:linear-gradient(135deg,#f5f8ff,#e8f1ff);box-shadow:0 12px 24px rgba(15,23,42,.06);display:flex;flex-direction:column;gap:14px;transition:transform .25s ease,box-shadow .25s ease}
  .stage-card.stage-completed{background:linear-gradient(135deg,rgba(16,185,129,.16),rgba(16,185,129,.18));border-color:rgba(16,185,129,.35)}
  .stage-card.stage-in-progress{background:linear-gradient(135deg,rgba(37,99,235,.12),rgba(37,99,235,.08));border-color:rgba(37,99,235,.2)}
  .stage-card.stage-completed .progress-shell{background:rgba(233,247,240,.8)}
  .stage-card.stage-in-progress .progress-shell{background:rgba(232,238,250,.9)}
  .stage-card:hover{transform:translateY(-3px);box-shadow:0 18px 32px rgba(15,23,42,.12)}
  .stage-header{display:flex;flex-wrap:wrap;justify-content:space-between;gap:16px}
  .stage-info{flex:1 1 220px;min-width:0}
  .stage-title{margin:0;font-size:15px;font-weight:700;display:flex;align-items:center;gap:10px;color:var(--text-main)}
  .stage-title .stage-percent{font-size:12px;color:var(--brand-dark);background:rgba(37,99,235,.16);padding:2px 12px;border-radius:999px;font-weight:700}
  .stage-description{margin:6px 0 0;font-size:12px;color:var(--text-muted);line-height:1.6}
  .stage-meta{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:180px}
  .stage-status{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:999px;font-size:12px;font-weight:700}
  .stage-card.stage-completed .stage-status{background:rgba(16,185,129,.16);color:var(--ok)}
  .stage-card.stage-in-progress .stage-status{background:rgba(37,99,235,.16);color:var(--brand-dark)}
  .stage-card.stage-pending .stage-status{background:rgba(110,114,134,.12);color:var(--text-muted)}
  .stage-amounts{display:flex;flex-direction:column;align-items:flex-end;gap:2px;font-size:12px;color:var(--text-muted)}
  .stage-amounts strong{color:var(--text-main)}
  .stage-remaining{color:var(--danger);font-weight:600}
  .stage-card.stage-in-progress .stage-remaining{color:var(--brand-dark)}
  .stage-card.stage-completed .stage-remaining{color:var(--ok)}
  .stage-progress{height:10px;margin-top:0}
  .stage-progress .progress-label{font-size:11px}
  .app-shell{padding-inline:clamp(10px,3vw,18px)}
  @media (max-width:640px){
    .modal-panel{padding:24px 20px}
    .modal-close{top:14px;inset-inline-end:14px}
    .modal-share{top:14px;inset-inline-start:14px}
    .stage-meta{align-items:flex-start;min-width:0}
    .stage-amounts{align-items:flex-start;text-align:right}
    header{padding:32px 16px 24px;border-radius:0 0 18px 18px}
    header .header-content{flex-direction:column;align-items:flex-start;gap:12px}
    .user-area{width:100%;justify-content:space-between}
    .container{margin:12px auto 20px;border-radius:16px;padding:18px 16px}
    .grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .card{padding:12px;border-radius:14px;min-height:100px}
    .card .card-title{font-size:12px}
    .card .card-amount{font-size:17px}
    .summary-card small{font-size:11px}
  }

  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  input,select,button{padding:10px 12px;border:1px solid #d6d9e5;border-radius:12px;font-size:14px;font-family:inherit;background:#fff;color:var(--text-main);transition:border-color .25s,box-shadow .25s,transform .15s ease}
  input:focus,select:focus,button:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.18)}
  button{background:linear-gradient(135deg,var(--brand),var(--brand-dark));color:#fff;border:none;cursor:pointer;font-weight:700;box-shadow:0 10px 20px rgba(37,99,235,.18)}
  button:hover{filter:brightness(1.02);transform:translateY(-1px)}
  .btn-okay{background:linear-gradient(135deg,var(--ok),#0ea472)} .btn-okay:hover{filter:brightness(1.02)}
  .btn-danger{background:linear-gradient(135deg,var(--danger),#f87171)} .btn-danger:hover{filter:brightness(1.02)}
  .records-delete-btn{
    width:36px;
    height:36px;
    border-radius:12px;
    border:none;
    background:rgba(239,68,68,.12);
    color:var(--danger);
    font-size:20px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition:background .25s ease,color .25s ease,transform .2s ease;
    box-shadow:0 6px 12px rgba(239,68,68,.12);
  }
  .records-delete-btn:hover{
    background:rgba(239,68,68,.18);
    color:#fff;
    transform:translateY(-2px);
  }
  .records-delete-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(239,68,68,.2)}

  .records-edit-btn{
    width:36px;
    height:36px;
    border-radius:12px;
    border:none;
    background:rgba(37,99,235,.12);
    color:var(--brand-dark);
    font-size:18px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition:background .25s ease,color .25s ease,transform .2s ease;
    box-shadow:0 6px 12px rgba(37,99,235,.12);
  }
  .records-edit-btn:hover{
    background:rgba(37,99,235,.2);
    color:#fff;
    transform:translateY(-2px);
  }
  .records-edit-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.2)}

  .records-actions-cell{display:flex;gap:8px;align-items:center;justify-content:flex-start}

  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0 20px}
  .records-controls{margin-top:24px}
  .records-header{display:grid;grid-template-columns=minmax(240px,1fr) auto;gap:16px;align-items:center;margin-bottom:16px;padding:16px;border:1px solid #d7def6;border-radius:16px;background:linear-gradient(145deg,#fff,#eef3ff);box-shadow:0 6px 18px rgba(15,23,42,.06)}
  .records-header input[type="search"]{width:100%;min-width:0;text-align:right;padding-inline-end:40px;padding-inline-start:12px;background:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="%236e7286" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" viewBox="0 0 24 24"%3E%3Ccircle cx="11" cy="11" r="7"/%3E%3Cpath d="m20 20-2.65-2.65"/%3E%3C/svg%3E') no-repeat calc(100% - 12px) center #fff;background-size:18px auto}
  .records-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .records-actions button{min-width:120px}
  .records-inline-filters{grid-column:1/ -1;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;padding:12px;border-radius:12px;background:#f0f4ff;border:1px solid rgba(37,99,235,.12)}
  .records-inline-filters::-webkit-scrollbar{height:6px}
  .records-inline-filters::-webkit-scrollbar-thumb{background:rgba(37,99,235,.35);border-radius:999px}
  .records-inline-filters .filter-field{min-width:0}
  .records-inline-filters .button-field{display:flex;align-items:center;justify-content:flex-end;justify-self:end;align-self:center}
  .records-inline-filters .button-field label{visibility:hidden;height:0;margin:0;padding:0}
  .records-inline-filters .button-field button{white-space:nowrap}
  .entry-controls{margin-top:16px}
  .entry-inline{display:flex;flex-wrap:wrap;align-items:center;gap:10px;padding:14px;border-radius:16px;background:linear-gradient(145deg,#fff,#eef3ff);border:1px solid #d7def6;box-shadow:0 6px 18px rgba(15,23,42,.06)}
  .entry-inline.editing{border-color:rgba(37,99,235,.4);box-shadow:0 10px 28px rgba(37,99,235,.08)}
  .entry-inline .entry-action{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .entry-inline .entry-action button{min-width:110px;padding:12px 18px;border-radius:14px;font-weight:700;box-shadow:0 10px 20px rgba(10,143,90,.18)}
  .entry-inline .entry-action .cancel-edit{background:rgba(15,23,42,.06);color:var(--text-main);box-shadow:none}
  .entry-inline .entry-action .cancel-edit:hover{background:rgba(15,23,42,.12)}
  .entry-inline .entry-field{position:relative;display:flex;align-items:center;flex:1 1 150px;min-width:0;background:#fff;border:1px solid rgba(37,99,235,.14);border-radius:14px;padding-inline:12px;height:48px;box-shadow:0 6px 14px rgba(15,23,42,.04)}
  .entry-inline .entry-field input,
  .entry-inline .entry-field select{border:none;background:transparent;padding:0;width:100%;height:100%;font-size:14px}
  .entry-inline .entry-field input:focus,
  .entry-inline .entry-field select:focus{box-shadow:none}
  .entry-inline .entry-field:focus-within{border-color:var(--brand);box-shadow:0 0 0 3px rgba(229,57,53,.15)}
  .entry-inline .entry-field select{appearance:none;-webkit-appearance:none;-moz-appearance:none;padding-inline-end:26px}
  .entry-inline .entry-field.has-select::after{content:"";position:absolute;inset-inline-end:12px;width:8px;height:8px;border-inline-end:2px solid var(--text-muted);border-block-end:2px solid var(--text-muted);transform:rotate(-45deg);pointer-events:none;opacity:.5}
  .entry-inline .entry-field input[type="date"]::-webkit-calendar-picker-indicator,
  .entry-inline .entry-field input[type="number"]::-webkit-inner-spin-button{opacity:0}
  .entry-inline .entry-field input[type="number"]{direction:ltr;text-align:right}
  .entry-inline .entry-field input[type="text"]{text-align:right}
  .entry-inline .entry-field input[type="date"]{
    color:var(--text-muted);
    direction:ltr;
    text-align:center;
    font-variant-numeric:tabular-nums;
  }
  .entry-inline .entry-field input[type="date"]:focus{color:var(--text-main)}
  .entry-inline .entry-field.has-icon input{padding-inline-end:28px}
  .entry-inline .entry-field.has-icon::after{content:"";position:absolute;inset-inline-end:12px;width:18px;height:18px;background:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="%236e7286" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"%3E%3Crect x="3" y="4.5" width="12" height="10.5" rx="2"/%3E%3Cpath d="M3 7.5h12M6 3v3m6-3v3"/%3E%3C/svg%3E') center/contain no-repeat;opacity:.7;pointer-events:none}
  .entry-inline .entry-field select:focus-visible,
  .entry-inline .entry-field input:focus-visible{outline:none}
  .filter-field{display:flex;flex-direction:column;gap:4px;white-space:nowrap}
  .filter-field label{font-size:12px;font-weight:600;color:var(--text-muted)}
  .filter-field input,.filter-field select{padding:8px 10px;font-size:13px;border-radius:10px}
  .filter-field button{padding:8px 14px;font-size:13px;border-radius:10px}
  .filter-field input[type="date"]{
    direction:ltr;
    text-align:center;
    font-variant-numeric:tabular-nums;
  }
  .clear-filter{background:rgba(215,38,61,.12);color:var(--danger)}
  .clear-filter:hover{background:rgba(215,38,61,.18)}
  @media (max-width:900px){
    .records-header{grid-template-columns:1fr;gap:14px;padding:14px}
    .records-actions{justify-content:flex-start}
    .records-actions button{flex:1 1 160px;min-width:0}
  }
  @media (max-width:600px){
    .records-inline-filters{grid-template-columns:1fr;gap:10px}
    .filter-field{white-space:normal}
  }
  @media (max-width:768px){
    .entry-inline{gap:12px}
    .entry-inline .entry-action{flex:1 1 100%}
    .entry-inline .entry-action button{width:100%}
    .entry-inline .entry-field{flex:1 1 calc(50% - 6px)}
  }
  @media (max-width:520px){
    .entry-inline{flex-direction:column;align-items:stretch}
    .entry-inline .entry-field{width:100%}
  }

  #categoryProgress{
    --cat-gap:clamp(4px,1.2vw,14px);
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    justify-content:flex-start;
    padding-bottom:6px;
    gap:var(--cat-gap);
  }
  #categoryProgress .card{
    width:100%;
    min-height:120px;
    padding:clamp(8px,1.8vw,14px);
    border-radius:clamp(10px,2.4vw,16px);
  }
  #categoryProgress .card .card-title{
    font-size:clamp(10px,1.9vw,13px);
    line-height:1.25;
  }
  #categoryProgress .card .card-share{
    font-size:clamp(9px,1.6vw,11px);
    color:var(--text-muted);
    display:block;
    margin-top:2px;
  }
  #categoryProgress .card .card-subtitle{font-size:clamp(9px,1.6vw,11px)}
  #categoryProgress .card .card-amount{font-size:clamp(13px,2.6vw,18px)}
  #categoryProgress .card .card-remaining{font-size:clamp(9px,1.7vw,11px)}
  #categoryProgress .progress-shell{margin-top:clamp(6px,1.4vw,10px);height:clamp(6px,.95vw,8px)}
  #categoryProgress .progress-label{font-size:clamp(8px,1.5vw,10px)}
  @media (max-width:600px){
    #categoryProgress{justify-content:center;grid-template-columns:repeat(3,minmax(0,1fr))}
    #categoryProgress .card{padding:clamp(8px,2.8vw,12px);min-width:0;text-align:right}
    #categoryProgress .card .card-title{line-height:1.25;font-size:14px}
    #categoryProgress .card .card-amount{font-weight:700;font-size:19px}
    #categoryProgress .card .card-subtitle{font-size:11px}
    #categoryProgress .card .card-share{font-size:11px}
    header h1{font-size:22px}
    .records-header{padding:12px}
    .records-inline-filters{grid-template-columns:1fr;gap:10px}
    .records-actions button{width:100%}
    .records-actions{width:100%;justify-content:stretch}
    input,select,button{font-size:15px}
  }

  .records-table{width:100%;border-collapse:collapse;margin-top:12px;background:var(--surface);overflow:hidden;border-radius:16px;min-width:780px}
  .records-table thead th{background:linear-gradient(135deg,var(--brand),var(--brand-dark));color:#fff;position:sticky;top:0;padding:12px 16px;font-weight:600;font-size:13px;white-space:nowrap;z-index:2}
  .records-table th,.records-table td{border-bottom:1px solid #eef0f6;padding:12px 16px;text-align:right;font-size:13px;color:var(--text-main)}
  .records-table tbody tr:nth-child(even){background:#fff7f7}
  .records-table tbody tr:hover{background:#ffeded}
  .records-table tbody td:nth-child(4){font-weight:600;color:var(--brand-dark)}
  .records-table tfoot td{background:linear-gradient(135deg,rgba(229,57,53,.12),rgba(19,189,125,.1));border-top:2px solid rgba(229,57,53,.25);font-weight:600;font-size:13px;color:var(--text-muted);padding:14px 18px}
  .records-table tfoot td:first-child{border-start-start-radius:16px;border-bottom-right-radius:16px;border-bottom-left-radius:16px}
  .records-table tfoot td:last-child{border-end-end-radius:16px;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
  .records-table tfoot span{display:block;font-size:12px;margin-bottom:4px}
  .records-table tfoot .footer-label{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
  .records-table tfoot strong{display:flex;align-items:center;gap:6px;font-size:16px;color:var(--text-main)}
  .records-table tfoot .footer-label strong{font-size:18px;color:var(--brand-dark)}
  .records-table tfoot .footer-amount.expense strong{color:var(--danger)}
  .records-table tfoot .footer-amount.income strong{color:var(--ok)}
  .records-table tfoot .footer-amount.transfer strong{color:var(--brand-dark)}
  .records-table tfoot .footer-balance strong{font-size:18px}
  .records-table tfoot .footer-balance strong.positive{color:var(--ok)}
  .records-table tfoot .footer-balance strong.negative{color:var(--danger)}
  .muted{color:var(--text-muted)}
  .error-text{color:var(--danger);font-weight:700;margin:6px 0 0;display:none}
  .login{max-width:420px;margin:40px auto;text-align:center}
  .config-link{margin-top:10px;display:inline-flex;gap:8px;align-items:center;font-weight:700;color:var(--brand);cursor:pointer;background:rgba(37,99,235,.12);border-radius:12px;padding:10px 14px;border:1px solid rgba(37,99,235,.2);text-decoration:none}
  .config-link:hover{filter:brightness(1.03)}
  .config-link small{color:var(--text-muted);font-weight:600}
  .config-form{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .config-form label{font-size:12px;font-weight:700;color:var(--text-muted);text-align:right}
  .config-form input{width:100%}
  .config-form .actions{display:flex;gap:10px;justify-content:flex-start;flex-wrap:wrap;margin-top:4px}
  .config-form .actions button{flex:1 1 120px;min-width:120px}
</style>

<!-- مكتبات التصدير -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Firebase (App + Auth + Firestore) -->
<script type="module">
  /******** Firebase ********/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const DEFAULT_FIREBASE_CONFIG = {
  apiKey: "AIzaSyC2LNZUEBtYSfslRsyLqP0_Mr-Z5lxPsz4",
  authDomain: "emad-84544.firebaseapp.com",
  projectId: "emad-84544",
  storageBucket: "emad-84544.firebasestorage.app",
  messagingSenderId: "144473116668",
  appId: "1:144473116668:web:25b629bf2c84461122ac79",
  measurementId: "G-3JBC3V67CE"
};
  const getStoredFirebaseConfig = ()=>{
    try{
      const raw = localStorage.getItem("emadFirebaseConfig");
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(parsed?.apiKey && parsed?.authDomain && parsed?.projectId){
        return parsed;
      }
    }catch(_){ /* ignore parsing issues */ }
    return null;
  };

  const saveFirebaseConfig = (config)=>{
    try{
      localStorage.setItem("emadFirebaseConfig", JSON.stringify(config));
    }catch(_){ /* ignore quota errors */ }
  };

  const loadFirebaseConfig = ()=>{
    return getStoredFirebaseConfig() || DEFAULT_FIREBASE_CONFIG;
  };

  let firebaseApp;
  let auth;
  let db;
  let entriesRef;
  let authUnsubscribe = null;
  let firebaseConfig = loadFirebaseConfig();
  let firebaseInitFailed = false;

  const bootFirebase = ()=>{
    firebaseConfig = loadFirebaseConfig();
    firebaseApp = initializeApp(firebaseConfig);
    auth = getAuth(firebaseApp);
    db = getFirestore(firebaseApp);
    entriesRef = collection(db, "entries");
    firebaseInitFailed = false;
  };

  try{
    bootFirebase();
  }catch(err){
    firebaseInitFailed = true;
    console.error("Firebase initialization failed", err);
  }

  /******** الحالة العامة ********/
  const categories = ["المنزل","مصاريف شخصية","الأهل","سيارة وبنزين","إدخار","ديون"];
  let entries = [];
  let filteredEntries = [];
  let currentUserEmail = null;
  let editingEntryId = null;

  // التوقعات (تُستخدم للعرض فقط)
  const defaultExpected = {
    "المنزل": 100000,
    "مصاريف شخصية": 226000,
    "الأهل": 151000,
    "سيارة وبنزين": 400000,
    "إدخار": 25000,
    "ديون": 80000
  };
  const cloneData = (value)=>{
    if(typeof structuredClone === "function"){
      return structuredClone(value);
    }
    try{
      return JSON.parse(JSON.stringify(value));
    }catch(_){
      return value;
    }
  };
  let expectedTotals = cloneData(defaultExpected);
  let activeCategoryTrigger = null;
  let activeCategoryName = null;

  /******** أدوات واجهة ********/
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tbody = $("#entriesBody");
  const tableFooterRow = $("#entriesFooter");
  const searchInput = $("#searchBox");
  const filterCategory = $("#filterCategory");
  const filterFrom = $("#filterFrom");
  const filterTo = $("#filterTo");
  const clearFiltersBtn = $("#clearFilters");
  const entryForm = $("#entryForm");
  const entryDateInput = $("#entryDate");
  const entryAmountInput = $("#entryAmount");
  const entryCategorySelect = $("#entryCategory");
  const entryNotesInput = $("#entryNotes");
  const entrySubmitButton = $("#entrySubmitButton");
  const entryCancelEdit = $("#entryCancelEdit");
  const userArea = $("#userArea");
  const categoryModal = $("#categoryModal");
  const closeCategoryModalBtn = $("#closeCategoryModal");
  const categoryModalTitle = $("#categoryModalTitle");
  const categoryModalSubtitle = $("#categoryModalSubtitle");
  const categoryModalBody = $("#categoryModalBody");
  const categoryModalFooter = $("#categoryModalFooter");
  const shareCategoryModalBtn = $("#shareCategoryModal");
  const loginError = $("#loginError");
  const loginButton = $("#loginButton");
  const loginForm = $("#loginForm");
  const emailInput = $("#email");
  const passwordInput = $("#password");
  const firebaseConfigButton = $("#firebaseConfigButton");
  const firebaseConfigModal = $("#firebaseConfigModal");
  const closeFirebaseConfigModal = $("#closeFirebaseConfigModal");
  const firebaseConfigForm = $("#firebaseConfigForm");
  const configInputs = firebaseConfigForm ? {
    apiKey: $("#configApiKey"),
    authDomain: $("#configAuthDomain"),
    projectId: $("#configProjectId"),
    storageBucket: $("#configStorageBucket"),
    messagingSenderId: $("#configMessagingSenderId"),
    appId: $("#configAppId"),
    measurementId: $("#configMeasurementId"),
  } : {};

  if(shareCategoryModalBtn){
    shareCategoryModalBtn.dataset.originalText = shareCategoryModalBtn.textContent.trim();
    shareCategoryModalBtn.dataset.originalHtml = shareCategoryModalBtn.innerHTML;
  }

  const ensureCategoryOptionExists = (value)=>{
    if(!value || !entryCategorySelect) return;
    const exists = Array.from(entryCategorySelect.options).some(opt=> opt.value === value);
    if(!exists){
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = value;
      entryCategorySelect.appendChild(opt);
    }
  };

  const updateEntryActionLabels = ()=>{
    const isEditing = Boolean(editingEntryId);
    if(entryForm){
      entryForm.classList.toggle("editing", isEditing);
    }
    if(entrySubmitButton){
      entrySubmitButton.textContent = isEditing ? "تحديث السجل" : "إضافة";
    }
    if(entryCancelEdit){
      entryCancelEdit.style.display = isEditing ? "inline-flex" : "none";
    }
  };

  const resetEntryForm = ()=>{
    if(entryDateInput){
      entryDateInput.valueAsDate = new Date();
    }
    if(entryAmountInput){
      entryAmountInput.value = "";
    }
    if(entryCategorySelect){
      entryCategorySelect.value = "";
    }
    if(entryNotesInput){
      entryNotesInput.value = "";
    }
    editingEntryId = null;
    updateEntryActionLabels();
  };

  window.cancelEdit = ()=> resetEntryForm();

  updateEntryActionLabels();

  const showLoginError = (message="")=>{
    if(!loginError) return;
    loginError.textContent = message;
    loginError.style.display = message?"block":"none";
  };

  const describeAuthError = (err)=>{
    if(!err) return "تعذّر تسجيل الدخول. تحقق من البيانات وحاول مجددًا.";
    const code = err?.code || "";
    switch(code){
      case "auth/missing-password": return "يرجى إدخال كلمة المرور لهذا الحساب.";
      case "auth/invalid-email": return "صيغة البريد الإلكتروني غير صحيحة.";
      case "auth/invalid-credential":
      case "auth/wrong-password": return "كلمة المرور غير صحيحة.";
      case "auth/user-not-found": return "لا يوجد حساب مسجل بهذا البريد.";
      case "auth/too-many-requests": return "تم إيقاف المحاولات مؤقتًا بسبب عدة محاولات فاشلة. حاول لاحقًا.";
      case "auth/network-request-failed": return "تعذّر الاتصال بالإنترنت. تأكد من الشبكة ثم حاول مجددًا.";
      case "auth/user-disabled": return "تم تعطيل هذا الحساب من قبل المسؤول.";
      case "auth/operation-not-allowed": return "مزود البريد/كلمة المرور غير مفعل في إعدادات Firebase.";
      case "auth/unauthorized-domain":
      case "auth/configuration-not-found": return "هذا النطاق غير مصرح به في إعدادات Firebase. افتح التطبيق من نطاق مسموح أو أضفه من لوحة التحكم.";
      case "auth/invalid-api-key": return "مفتاح Firebase API غير صالح أو مقيّد. حدّث الإعدادات من زر \"إعدادات الاتصال\" أدناه.";
      default:
        return `تعذّر تسجيل الدخول. (${code||"unknown"})`;
    }
  };

  const setLoginLoading = (isLoading)=>{
    if(loginButton){
      loginButton.disabled = !!isLoading;
      loginButton.textContent = isLoading?"جاري الدخول...":"دخول";
    }
    if(emailInput) emailInput.disabled = !!isLoading;
    if(passwordInput) passwordInput.disabled = !!isLoading;
  };

  function translateType(){ return "مصروف"; }
  const userCodes = {
    "jawdat.saleh99@gmail.com": "A2",
    "emad.lk9@gmail.com": "A1"
  };
  function getUserCode(email){
    if(!email) return "";
    return userCodes[email] || email;
  }

  const numberFormatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0, minimumFractionDigits: 0 });
  const roundNumber = value => Math.round(Number(value) || 0);
  const formatNumber = value => numberFormatter.format(roundNumber(value));
  const currencySymbol = '<span class="currency-symbol">﷼</span>';
  const formatCurrency = value => `${formatNumber(value)} ${currencySymbol}`;
  function renderCategoryModal(category){
    const targetCategory = category ?? activeCategoryName;
    if(!targetCategory) return;
    if(categoryModalTitle){
      categoryModalTitle.textContent = `سجلات فئة ${targetCategory}`;
    }
    if(categoryModalSubtitle){
      categoryModalSubtitle.textContent = "عرض جميع السجلات المسجلة لهذه الفئة.";
    }
    if(!categoryModalBody || !categoryModalFooter) return;
    categoryModalBody.innerHTML = "";

    const categoryEntries = entries.filter(e=> e.category === targetCategory);
    let totalExpenses = 0;

    if(shareCategoryModalBtn){
      const hasEntries = categoryEntries.length > 0;
      shareCategoryModalBtn.disabled = !hasEntries;
      shareCategoryModalBtn.setAttribute("aria-disabled", hasEntries ? "false" : "true");
      shareCategoryModalBtn.title = hasEntries ? "" : "لا توجد سجلات لمشاركتها حالياً";
    }

    if(categoryEntries.length === 0){
      const emptyRow = document.createElement("tr");
      emptyRow.innerHTML = '<td colspan="7" style="text-align:center;color:var(--text-muted);">لا توجد سجلات لهذه الفئة حتى الآن.</td>';
      categoryModalBody.appendChild(emptyRow);
    }else{
      categoryEntries.forEach(entry=>{
        const amount = Number(entry.amount||0);
        totalExpenses += amount;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.id?.slice?.(0,6) || entry.id || ""}</td>
          <td>${entry.date || ""}</td>
          <td>${formatNumber(entry.amount || 0)}</td>
          <td>${getUserCode(entry.user)}</td>
          <td>${entry.notes || ""}</td>
        `;
        categoryModalBody.appendChild(tr);
      });
    }
    categoryModalFooter.innerHTML = `
      <td colspan="2" class="footer-label">
        <span>عدد السجلات</span>
        <strong>${formatNumber(categoryEntries.length)}</strong>
      </td>
      <td class="footer-amount expense">
        <span>إجمالي المصروفات</span>
        <strong>${formatCurrency(totalExpenses)}</strong>
      </td>
      <td colspan="2"></td>
    `;
  }

  function openCategoryModal(category, triggerEl){
    if(!categoryModal) return;
    activeCategoryTrigger = triggerEl || null;
    activeCategoryName = category;
    categoryModal.dataset.category = category;
    renderCategoryModal(category);
    categoryModal.classList.add("active");
    categoryModal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    const panel = categoryModal.querySelector(".modal-panel");
    panel?.focus();
  }

  function closeCategoryModal(){
    if(!categoryModal) return;
    categoryModal.classList.remove("active");
    categoryModal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    if(activeCategoryTrigger){
      activeCategoryTrigger.focus();
    }
    activeCategoryTrigger = null;
    activeCategoryName = null;
    categoryModal.removeAttribute("data-category");
    if(shareCategoryModalBtn){
      shareCategoryModalBtn.disabled = false;
      shareCategoryModalBtn.setAttribute("aria-disabled", "false");
      shareCategoryModalBtn.innerHTML = shareCategoryModalBtn.dataset.originalHtml || shareCategoryModalBtn.innerHTML;
    }
  }

  async function ensureHtml2Canvas(){
    if(typeof window === "undefined") return null;
    if(typeof window.html2canvas === "function") return window.html2canvas;

    let loader = document.querySelector('script[data-html2canvas-loader="true"]');
    if(!loader){
      loader = document.createElement("script");
      loader.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
      loader.async = true;
      loader.crossOrigin = "anonymous";
      loader.referrerPolicy = "no-referrer";
      loader.dataset.html2canvasLoader = "true";
      const integrity = "sha512-BNa5u86XC0ZAY7WjVB7FtBVVn7a4MyuMxDN/68LUEDlTF/WZ0zR1ekR4WagM9YIvEBSGIWXhe/9QgW8qCV3R8A==";
      loader.integrity = integrity;
      document.head.appendChild(loader);
    }

    await new Promise((resolve, reject)=>{
      if(loader.dataset.loaded){
        resolve();
        return;
      }
      const handleLoad = ()=>{
        loader.removeEventListener("load", handleLoad);
        loader.removeEventListener("error", handleError);
        loader.dataset.loaded = "true";
        resolve();
      };
      const handleError = ()=>{
        loader.removeEventListener("load", handleLoad);
        loader.removeEventListener("error", handleError);
        reject(new Error("HTML2CANVAS_LOAD_ERROR"));
      };
      loader.addEventListener("load", handleLoad);
      loader.addEventListener("error", handleError);
    }).catch(()=>{});

    return typeof window.html2canvas === "function" ? window.html2canvas : null;
  }

  closeCategoryModalBtn?.addEventListener("click", closeCategoryModal);
  
  async function shareCategoryRecordsAsImage(){
    const canvasFn = await ensureHtml2Canvas();
    if(!canvasFn){
      alert("تعذّر إنشاء صورة في هذا المتصفح.");
      return;
    }
    const tableWrapper = categoryModal?.querySelector(".modal-table-wrapper");
    if(!tableWrapper){
      alert("لا توجد بيانات لمشاركتها.");
      return;
    }
    shareCategoryModalBtn.innerHTML = '<span class="share-icon">…</span><span>جاري التجهيز</span>';
    try{
      const canvas = await canvasFn(tableWrapper, { backgroundColor: "#ffffff", scale: 2 });
      const dataUrl = canvas.toDataURL("image/png");
      if(navigator.share && navigator.canShare){
        const blob = await (await fetch(dataUrl)).blob();
        const file = new File([blob], "records.png", { type: "image/png" });
        if(navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], title:"حسابات", text:"سجلات الفئة" });
          return;
        }
      }
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "records.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){
      console.error(e);
      alert("حدث خطأ أثناء إنشاء الصورة.");
    }finally{
      if(shareCategoryModalBtn){
        shareCategoryModalBtn.innerHTML = shareCategoryModalBtn.dataset.originalHtml || "مشاركة كصورة";
      }
    }
  }

  shareCategoryModalBtn?.addEventListener("click", shareCategoryRecordsAsImage);
  categoryModal?.addEventListener("click", evt=>{
    if(evt.target === categoryModal){
      closeCategoryModal();
    }
  });
  document.addEventListener("keydown", evt=>{
    if(evt.key === "Escape"){
      if(categoryModal?.classList.contains("active")){
        closeCategoryModal();
      }
    }
  });
  const ensureFirebaseReady = ()=>{
    if(firebaseInitFailed) return false;
    if(auth) return true;
    try{
      bootFirebase();
      return !!auth;
    }catch(err){
      firebaseInitFailed = true;
      console.error("Firebase boot retry failed", err);
      return false;
    }
  };

  const setConfigFormValues = ()=>{
    if(!firebaseConfigForm) return;
    const current = loadFirebaseConfig();
    Object.entries(configInputs).forEach(([key, input])=>{
      if(!input) return;
      input.value = current?.[key] ?? "";
    });
  };

  const openFirebaseConfigModal = ()=>{
    if(firebaseConfigModal){
      setConfigFormValues();
      firebaseConfigModal.classList.add("active");
      firebaseConfigModal.setAttribute("aria-hidden","false");
    }
  };

  const hideFirebaseConfigModal = ()=>{
    if(firebaseConfigModal){
      firebaseConfigModal.classList.remove("active");
      firebaseConfigModal.setAttribute("aria-hidden","true");
    }
  };

  /******** مصادقة ********/
  const startAuthListener = ()=>{
    if(!ensureFirebaseReady()){ return; }
    if(typeof authUnsubscribe === "function"){
      authUnsubscribe();
    }
    authUnsubscribe = onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserEmail = user.email;
        $("#loginBox").style.display="none";
        $("#app").style.display="block";
        showLoginError("");
        $("#userEmail").textContent = getUserCode(currentUserEmail);
        if(userArea) userArea.classList.add("visible");
        resetEntryForm();
        populateCategories();
        await loadEntries();
      }else{
        currentUserEmail = null;
        $("#app").style.display="none";
        $("#loginBox").style.display="block";
        $("#userEmail").textContent = "";
        showLoginError("");
        if(userArea) userArea.classList.remove("visible");
      }
      setLoginLoading(false);
    });
  };
  startAuthListener();

  if(firebaseInitFailed){
    showLoginError("تعذّر تهيئة Firebase بالمفاتيح الحالية. حدّث الإعدادات وجرب مجددًا.");
    openFirebaseConfigModal();
  }

  window.login = async ()=>{
    if(loginButton?.disabled) return;
    const email = $("#email").value.trim();
    const password = $("#password").value.trim();
    if(!email || !password){
      showLoginError("أدخل البريد وكلمة المرور لإتمام تسجيل الدخول.");
      return;
    }
    if(!ensureFirebaseReady()){
      showLoginError("لم يتم تهيئة Firebase. حدّث مفاتيح الاتصال ثم حاول مجددًا.");
      return;
    }
    try{
      setLoginLoading(true);
      await signInWithEmailAndPassword(auth, email, password);
      showLoginError("");
    }catch(err){
      const message = describeAuthError(err);
      showLoginError(message);
    }
    finally{ setLoginLoading(false); }
  };

  if(loginForm){
    loginForm.addEventListener("submit",(e)=>{ e.preventDefault(); login(); });
  }

  if(firebaseConfigButton){
    firebaseConfigButton.addEventListener("click", openFirebaseConfigModal);
  }

  if(closeFirebaseConfigModal){
    closeFirebaseConfigModal.addEventListener("click", hideFirebaseConfigModal);
  }

  if(firebaseConfigModal){
    firebaseConfigModal.addEventListener("click",(e)=>{
      if(e.target === firebaseConfigModal){
        hideFirebaseConfigModal();
      }
    });
  }

  if(firebaseConfigForm){
    setConfigFormValues();
    firebaseConfigForm.addEventListener("submit",(e)=>{
      e.preventDefault();
      const formData = new FormData(firebaseConfigForm);
      const newConfig = {};
      Object.keys(configInputs).forEach((key)=>{
        const value = (formData.get(key)||"").toString().trim();
        if(value) newConfig[key] = value;
      });
      const requiredFields = ["apiKey","authDomain","projectId"];
      const missing = requiredFields.filter(f=>!newConfig[f]);
      if(missing.length){
        showLoginError(`يرجى تعبئة الحقول المطلوبة: ${missing.join(", ")}`);
        return;
      }
      try{
        saveFirebaseConfig(newConfig);
        bootFirebase();
        startAuthListener();
        showLoginError("تم حفظ إعدادات Firebase. حاول تسجيل الدخول مجددًا.");
        hideFirebaseConfigModal();
      }catch(err){
        firebaseInitFailed = true;
        console.error("Failed to apply Firebase config", err);
        showLoginError("تعذّر تطبيق الإعدادات الجديدة. تأكد من صحة المفاتيح والمحاولة مرة أخرى.");
      }
    });
  }

  window.logout = ()=> signOut(auth);

  window.resetPassword = async ()=>{
    const email = $("#email").value.trim();
    if(!email) return alert("أدخل بريدك في خانة البريد ثم اضغط استعادة كلمة المرور.");
    try{
      await sendPasswordResetEmail(auth, email);
      alert("تم إرسال رابط تغيير كلمة المرور إلى بريدك.");
    }catch(e){ alert("تعذّر الإرسال: "+(e.message||e)); }
  };

  /******** تحميل / حفظ / حذف ********/
  async function loadEntries(){
    const qy = query(entriesRef, orderBy("createdAt","desc"));
    const snap = await getDocs(qy).catch(async ()=> await getDocs(entriesRef));
    const list = [];
    snap.forEach(d=> list.push({ id:d.id, ...d.data() }));
    list.sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")));
    entries = list;
    applyFilters();
  }

  async function saveEntry(entry){
    await addDoc(entriesRef, { ...entry, createdAt: serverTimestamp() });
  }

  async function removeEntry(id){
    await deleteDoc(doc(db,"entries",id));
  }

  window.editEntry = async (id)=>{
    const current = entries.find(e=> e.id === id);
    if(!current){
      alert("السجل غير موجود.");
      return;
    }

    ensureCategoryOptionExists(current.category);
    if(entryDateInput){
      entryDateInput.value = current.date || "";
    }
    if(entryAmountInput){
      entryAmountInput.value = current.amount ?? "";
    }
    if(entryCategorySelect){
      entryCategorySelect.value = current.category || "";
    }
    if(entryNotesInput){
      entryNotesInput.value = current.notes || "";
    }

    editingEntryId = id;
    updateEntryActionLabels();
    entryDateInput?.focus();
    entryForm?.scrollIntoView({ behavior: "smooth", block: "center" });
  };

  window.deleteEntry = async (id)=>{
    const password = prompt("يرجى إدخال كلمة المرور لحذف السجل:");
    if(password===null) return;
    if(password.trim()!=="40145"){
      alert("كلمة المرور غير صحيحة.");
      return;
    }
    await removeEntry(id);
    await loadEntries();
  };

  /******** بطاقات / توقعات ********/
  function updateTotals(){
    let totalExpenses=0;
    const catTotals = Object.fromEntries(categories.map(c=>[c,0]));

    entries.forEach(e=>{
      const amount = Number(e.amount||0);
      totalExpenses += amount;
      if(catTotals[e.category]!=null) catTotals[e.category]+=amount;
    });

    $("#totalExpenses").innerHTML = formatCurrency(totalExpenses);

    const row = $("#categoryProgress");
    if(row){
      row.innerHTML = "";
      for(const cat of categories){
        const sum = catTotals[cat]||0;
        const exp = expectedTotals[cat]||0;
        const hasExpectation = exp > 0;
        const rawPerc = hasExpectation ? (sum/exp*100) : 0;
        const perc = hasExpectation ? Math.min(Math.max(rawPerc,0),100) : 0;
        const alertState = hasExpectation && rawPerc >= 100;
        const progressLabel = hasExpectation ? `${Math.round(rawPerc)}%` : "—";
        const shareOfTotal = totalExpenses > 0 ? Math.min(Math.max((sum/totalExpenses)*100,0),100) : 0;
        const card = document.createElement("div");
        card.className = "card category-card clickable";
        card.innerHTML = `
          <div class="card-header">
            <span class="card-title">${cat}</span>
          </div>
          <small class="card-share">نسبة من الإجمالي: ${Math.round(shareOfTotal)}%</small>
          <div class="card-amount">${formatCurrency(sum)}</div>
          <div class="progress-shell" data-progress="${perc}" data-alert="${alertState}">
            <div class="progress-bar"></div>
            <span class="progress-label">${progressLabel}</span>
          </div>
        `;
        card.dataset.category = cat;
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");
        card.setAttribute("aria-haspopup","dialog");
        card.setAttribute("aria-controls","categoryModal");
        card.addEventListener("click", ()=> openCategoryModal(cat, card));
        card.addEventListener("keydown", evt=>{
          if(evt.key === "Enter" || evt.key === " "){
            evt.preventDefault();
            openCategoryModal(cat, card);
          }
        });
        if(activeCategoryName === cat && categoryModal?.classList.contains("active")){
          activeCategoryTrigger = card;
        }
        row.appendChild(card);

        const shell = card.querySelector(".progress-shell");
        const bar = shell.querySelector(".progress-bar");
        bar.style.width = "0%";
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            bar.style.width = `${shell.dataset.progress}%`;
          });
        });
      }
      if(categoryModal?.classList.contains("active") && activeCategoryName === cat){
        renderCategoryModal(activeCategoryName);
      }
    }
  }

  /******** عرض الجدول ********/
  function renderEntries(){
    tbody.innerHTML = "";
    filteredEntries.forEach(e=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.id?.slice?.(0,6)||e.id||""}</td>
        <td>${e.date||""}</td>
        <td>${formatNumber(e.amount||0)}</td>
        <td>${e.category||""}</td>
        <td>${getUserCode(e.user)}</td>
        <td>${e.notes||""}</td>
        <td>
          <div class="records-actions-cell">
            <button class="records-edit-btn" type="button" onclick="editEntry('${e.id}')" title="تعديل السجل" aria-label="تعديل السجل">✎</button>
            <button class="records-delete-btn" type="button" onclick="deleteEntry('${e.id}')" title="حذف السجل" aria-label="حذف السجل">&times;</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
    if(tableFooterRow){
      let footerExpenses = 0;
      filteredEntries.forEach(e=>{
        const amount = Number(e.amount||0);
        footerExpenses += amount;
      });
      tableFooterRow.innerHTML = `
        <td colspan="2" class="footer-label">
          <span>إجمالي السجلات المعروضة</span>
          <strong>${formatNumber(filteredEntries.length)}</strong>
        </td>
        <td class="footer-amount expense">
          <span>المصروفات</span>
          <strong>${formatCurrency(footerExpenses)}</strong>
        </td>
        <td colspan="4"></td>
      `;
    }
    updateTotals();
  }

  function populateCategories(){
    const sel = $("#entryCategory");
    sel.innerHTML = "";
    if(filterCategory){
      filterCategory.innerHTML = '<option value="">كل الفئات</option>';
    }
    categories.forEach(c=>{
      const opt = document.createElement("option");
      opt.value=c; opt.textContent=c;
      sel.appendChild(opt);
      if(filterCategory){
        const filterOpt = document.createElement("option");
        filterOpt.value = c;
        filterOpt.textContent = c;
        filterCategory.appendChild(filterOpt);
      }
    });
  }

  /******** حفظ إدخال جديد ********/
  window.submitEntry = async ()=>{
    if(!currentUserEmail){ alert("يرجى تسجيل الدخول أولًا"); return; }
    const date = entryDateInput?.value || "";
    const amount = parseFloat(entryAmountInput?.value ?? "");
    const category = entryCategorySelect?.value || "";
    const notes = entryNotesInput?.value || "";
    if(!date || Number.isNaN(amount) || !category){
      alert("الرجاء إدخال جميع الحقول المطلوبة"); return;
    }
    const baseEntry = { date, type: "expense", amount, category, notes };
    const existing = entries.find(e=> e.id === editingEntryId);

    if(editingEntryId){
      await updateDoc(doc(db,"entries", editingEntryId), {
        ...baseEntry,
        user: existing?.user || currentUserEmail,
        updatedAt: serverTimestamp()
      });
      alert("تم تعديل السجل بنجاح.");
    }else{
      await saveEntry({ ...baseEntry, user: currentUserEmail });
      alert("✅ تم الحفظ");
    }

    resetEntryForm();
    await loadEntries();
  };

  /******** التصفية والبحث ********/
  function applyFilters(){
    const q = (searchInput?.value || "").trim().toLowerCase();
    const categoryValue = filterCategory?.value || "";
    const fromValue = filterFrom?.value || "";
    const toValue = filterTo?.value || "";

    filteredEntries = entries.filter(e=>{
      const matchesSearch = !q || [e.id, e.date, e.amount, e.category, e.user, e.notes]
        .map(x=> (x??"").toString().toLowerCase()).some(v=> v.includes(q));
      if(!matchesSearch) return false;
      if(categoryValue && e.category !== categoryValue) return false;
      if(fromValue && (!e.date || e.date < fromValue)) return false;
      if(toValue && (!e.date || e.date > toValue)) return false;
      return true;
    });

    renderEntries();
  }

  searchInput?.addEventListener("input", ()=> applyFilters());
  [filterCategory].forEach(el=> el?.addEventListener("change", applyFilters));
  [filterFrom, filterTo].forEach(el=> el?.addEventListener("change", applyFilters));
  clearFiltersBtn?.addEventListener("click", ()=>{
    if(searchInput) searchInput.value = "";
    if(filterCategory) filterCategory.value = "";
    if(filterFrom) filterFrom.value = "";
    if(filterTo) filterTo.value = "";
    applyFilters();
  });

  /******** تصدير ********/
  window.exportPDF = ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:"l", unit:"pt"});
    doc.text("المصاريف الشخصية", 40, 30);
    const rows = filteredEntries.map(e=>[
      e.id, e.date, formatNumber(e.amount||0),
      e.category, getUserCode(e.user), e.notes||""
    ]);
    doc.autoTable({
      head:[["#","التاريخ","المبلغ","الفئة","المستخدم","ملاحظات"]],
      body:rows, startY:50
    });
    doc.save("personal-expenses.pdf");
  };

  window.exportXLSX = ()=>{
    const data = [
      ["#","التاريخ","المبلغ","الفئة","المستخدم","ملاحظات"],
      ...filteredEntries.map(e=>[
        e.id, e.date, roundNumber(e.amount||0),
        e.category, getUserCode(e.user), e.notes||""
      ])
    ];
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "السجلات");
    XLSX.writeFile(wb, "personal-expenses.xlsx");
  };
</script>
</head>
<body>

<header>
  <div class="header-content">
    <h1>مصاريفي الشخصية</h1>
    <div id="userArea" class="user-area">
      <span id="userEmail" class="user-email"></span>
      <button class="btn-danger logout-button" onclick="logout()">تسجيل الخروج</button>
    </div>
  </div>
</header>

<!-- شاشة دخول آمنة -->
<div id="loginBox" class="container login">
  <h3>تسجيل الدخول</h3>
  <form id="loginForm" class="row" style="justify-content:center" novalidate>
    <input id="email" type="email" placeholder="البريد الإلكتروني" autocomplete="username" required />
    <input id="password" type="password" placeholder="كلمة المرور" autocomplete="current-password" required />
    <button id="loginButton" type="submit">دخول</button>
    <button class="btn-okay" type="button" onclick="resetPassword()" title="إرسال رابط تغيير كلمة المرور">استعادة كلمة المرور</button>
  </form>
  <p id="loginError" class="error-text" aria-live="polite"></p>
  <button id="firebaseConfigButton" type="button" class="config-link" aria-haspopup="dialog">
    <span>إعدادات الاتصال</span>
    <small>تحديث مفاتيح Firebase</small>
  </button>
  <p class="muted">التسجيل مُغلق — فقط حسابات تتم إضافتها من Firebase Console تستطيع الدخول.</p>
</div>

<div id="firebaseConfigModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-panel" role="document" tabindex="-1">
    <button type="button" class="modal-close" id="closeFirebaseConfigModal" aria-label="إغلاق">&times;</button>
    <h2 class="modal-title">إعدادات اتصال Firebase</h2>
    <p class="modal-subtitle">حدّث المفاتيح في حال ظهور خطأ "API key not valid" أو عند نقل التطبيق إلى نطاق جديد.</p>
    <form id="firebaseConfigForm" class="config-form">
      <label>
        مفتاح API
        <input id="configApiKey" name="apiKey" type="text" autocomplete="off" required />
      </label>
      <label>
        نطاق المصادقة (authDomain)
        <input id="configAuthDomain" name="authDomain" type="text" autocomplete="off" required />
      </label>
      <label>
        رقم المشروع (projectId)
        <input id="configProjectId" name="projectId" type="text" autocomplete="off" required />
      </label>
      <label>
        Storage Bucket (اختياري)
        <input id="configStorageBucket" name="storageBucket" type="text" autocomplete="off" />
      </label>
      <label>
        Messaging Sender ID (اختياري)
        <input id="configMessagingSenderId" name="messagingSenderId" type="text" autocomplete="off" />
      </label>
      <label>
        App ID (اختياري)
        <input id="configAppId" name="appId" type="text" autocomplete="off" />
      </label>
      <label>
        Measurement ID (اختياري)
        <input id="configMeasurementId" name="measurementId" type="text" autocomplete="off" />
      </label>
      <div class="actions">
        <button type="submit" class="btn-okay">حفظ وتطبيق</button>
        <button type="button" class="btn-danger" onclick="localStorage.removeItem('emadFirebaseConfig'); location.reload();">إعادة الضبط</button>
      </div>
    </form>
    <p class="muted" style="margin-top:6px">يتم حفظ الإعدادات في هذا المتصفح فقط. تأكد من نقل المفاتيح الصحيحة من Firebase Console &raquo; Project settings &raquo; General &raquo; Config.</p>
  </div>
</div>

<!-- التطبيق -->
<div id="app" class="container" style="display:none;">
  <!-- بطاقات إجماليات -->
  <div class="grid">
    <div class="card summary-card"><small>إجمالي المصروفات</small><b id="totalExpenses">0 <span class="currency-symbol">﷼</span></b></div>
  </div>

  <div id="categoryModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="categoryModalTitle" aria-describedby="categoryModalSubtitle">
    <div class="modal-panel" role="document" tabindex="-1">
      <button type="button" class="modal-share" id="shareCategoryModal" aria-label="مشاركة جدول السجلات كصورة"><span class="share-icon">⇪</span><span>مشاركة كصورة</span></button>
      <button type="button" class="modal-close" id="closeCategoryModal" aria-label="إغلاق">&times;</button>
      <h2 class="modal-title" id="categoryModalTitle">سجلات الفئة</h2>
      <p class="modal-subtitle" id="categoryModalSubtitle">عرض مفصل لسجلات الفئة المختارة.</p>
      <div class="modal-table-wrapper">
        <table class="records-table">
          <thead>
            <tr>
              <th>#</th>
              <th>التاريخ</th>
              <th>المبلغ</th>
              <th>المستخدم</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody id="categoryModalBody"></tbody>
          <tfoot>
            <tr id="categoryModalFooter"></tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- بطاقات الفئات + القلم -->
  <div id="categoryProgress" class="grid" style="margin-top:10px;"></div>

  <h3 style="margin-top:16px">إضافة عملية</h3>
  <div class="entry-controls">
    <div id="entryForm" class="entry-inline">
      <div class="entry-action">
        <button id="entrySubmitButton" class="btn-okay" onclick="submitEntry()">إضافة</button>
        <button id="entryCancelEdit" type="button" class="cancel-edit" onclick="cancelEdit()" style="display:none">إلغاء التعديل</button>
      </div>
      <div class="entry-field has-icon">
        <input type="date" id="entryDate" lang="en-GB">
      </div>
      <div class="entry-field">
        <input type="number" id="entryAmount" step="0.01" placeholder="المبلغ (﷼)">
      </div>
      <div class="entry-field has-select">
        <select id="entryCategory"></select>
      </div>
      <div class="entry-field">
        <input type="text" id="entryNotes" placeholder="ملاحظات">
      </div>
    </div>
  </div>

  <h3 style="margin-top:12px">السجلات</h3>
  <div class="records-controls">
    <div class="records-header">
      <input id="searchBox" type="search" placeholder="           بحث في السجلات..." />
      <div class="records-actions">
        <button onclick="exportPDF()">تصدير PDF</button>
        <button onclick="exportXLSX()">تصدير Excel</button>
      </div>
      <div class="records-inline-filters">
        <div class="filter-field button-field">
          <label>&nbsp;</label>
          <button id="clearFilters" class="clear-filter">إعادة تعيين التصفية</button>
        </div>
        <div class="filter-field">
          <label for="filterCategory">الفئة</label>
          <select id="filterCategory">
            <option value="">كل الفئات</option>
          </select>
        </div>
        <div class="filter-field">
          <label for="filterFrom">من تاريخ</label>
          <input type="date" id="filterFrom" lang="en-GB" />
        </div>
        <div class="filter-field">
          <label for="filterTo">إلى تاريخ</label>
          <input type="date" id="filterTo" lang="en-GB" />
        </div>
      </div>
    </div>
  </div>
  <div style="overflow:auto; max-height:60vh;">
    <table class="records-table">
      <thead>
        <tr>
          <th>#</th><th>التاريخ</th><th>المبلغ</th><th>الفئة</th>
          <th>المستخدم</th><th>ملاحظات</th><th>إجراء</th>
        </tr>
      </thead>
      <tbody id="entriesBody"></tbody>
      <tfoot>
        <tr id="entriesFooter"></tr>
      </tfoot>
    </table>
  </div>
</div>
</body>
</html>
